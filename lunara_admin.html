<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lunara â€” Admin Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{
  --ink:#0e0c14;--ink2:#191626;--off:#f5f2ee;
  --coral:#e8553e;--violet:#6b3fa0;--blush:#f2c4b0;
  --sage:#8aab8c;--amber:#ffbe55;--muted:#7a7370;
  --border:rgba(245,242,238,0.09);--glow:rgba(232,85,62,0.22);
  --font:'Outfit',sans-serif;--serif:'Playfair Display',serif;
}
body{font-family:var(--font);background:var(--ink);color:var(--off);min-height:100vh;}

/* Login screen */
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;}
.login-box{background:#191626;border:1px solid var(--border);border-radius:24px;padding:48px;width:380px;max-width:calc(100% - 32px);}
.login-logo{font-family:var(--serif);font-size:28px;font-weight:900;margin-bottom:6px;}
.login-sub{font-size:13px;color:rgba(245,242,238,.4);margin-bottom:32px;}
.field{margin-bottom:16px;}
.field label{display:block;font-size:11px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:rgba(245,242,238,.4);margin-bottom:8px;}
.field input{width:100%;padding:13px 16px;border-radius:13px;border:1px solid var(--border);background:rgba(0,0,0,.3);color:var(--off);font-family:var(--font);font-size:14px;outline:none;transition:.2s;}
.field input:focus{border-color:rgba(232,85,62,.5);}
.field input::placeholder{color:rgba(245,242,238,.2);}
.btn-login{width:100%;padding:14px;border-radius:13px;background:linear-gradient(135deg,var(--coral),var(--violet));color:white;font-family:var(--font);font-size:15px;font-weight:700;border:none;cursor:pointer;transition:.25s;box-shadow:0 6px 24px var(--glow);}
.btn-login:hover{transform:translateY(-2px);box-shadow:0 10px 32px var(--glow);}
.login-err{color:#ff8080;font-size:13px;margin-top:12px;display:none;}

/* Dashboard */
.dash{display:none;}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:16px 32px;border-bottom:1px solid var(--border);background:rgba(14,12,20,.9);backdrop-filter:blur(16px);position:sticky;top:0;z-index:100;}
.topbar-brand{font-family:var(--serif);font-size:18px;font-weight:900;display:flex;align-items:center;gap:10px;}
.logo-pip{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--coral),var(--violet));display:flex;align-items:center;justify-content:center;font-size:14px;}
.topbar-right{display:flex;align-items:center;gap:16px;}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--sage);box-shadow:0 0 10px rgba(138,171,140,.5);animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}
.btn-sm{padding:8px 16px;border-radius:10px;border:1px solid var(--border);background:transparent;color:rgba(245,242,238,.6);font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;transition:.15s;}
.btn-sm:hover{color:var(--off);border-color:rgba(255,255,255,.25);}
.btn-sm.danger{border-color:rgba(232,85,62,.3);color:rgba(232,85,62,.8);}

.main{max-width:1100px;margin:0 auto;padding:32px 24px;}

/* KPI cards */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:28px;}
@media(max-width:700px){.kpi-row{grid-template-columns:1fr 1fr;}}
.kpi-card{background:#191626;border:1px solid var(--border);border-radius:18px;padding:22px;}
.kpi-label{font-size:11px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:rgba(245,242,238,.35);margin-bottom:8px;}
.kpi-val{font-family:var(--serif);font-size:32px;font-weight:800;line-height:1;}
.kpi-sub{font-size:12px;color:rgba(245,242,238,.35);margin-top:6px;}
.kpi-card.accent{border-color:rgba(232,85,62,.25);background:linear-gradient(160deg,rgba(232,85,62,.06),rgba(107,63,160,.04));}

/* Chart */
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:28px;}
@media(max-width:700px){.chart-row{grid-template-columns:1fr;}}
.panel{background:#191626;border:1px solid var(--border);border-radius:18px;padding:22px;}
.panel-title{font-family:var(--serif);font-size:16px;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:8px;}
.bar-item{margin-bottom:14px;}
.bar-label{display:flex;justify-content:space-between;font-size:13px;margin-bottom:5px;color:rgba(245,242,238,.7);}
.bar-track{height:6px;border-radius:4px;background:rgba(255,255,255,.06);}
.bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--coral),var(--violet));transition:.6s width;}

/* Table */
.table-panel{background:#191626;border:1px solid var(--border);border-radius:18px;margin-bottom:28px;overflow:hidden;}
.table-top{display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.06);}
.table-title{font-family:var(--serif);font-size:16px;font-weight:700;}
.search-input{padding:9px 14px;border-radius:10px;border:1px solid var(--border);background:rgba(0,0,0,.25);color:var(--off);font-family:var(--font);font-size:13px;outline:none;width:220px;transition:.2s;}
.search-input:focus{border-color:rgba(232,85,62,.4);}
.search-input::placeholder{color:rgba(245,242,238,.22);}
table{width:100%;border-collapse:collapse;}
th{text-align:left;padding:12px 22px;font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:rgba(245,242,238,.3);border-bottom:1px solid rgba(255,255,255,.06);}
td{padding:14px 22px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(255,255,255,.02);}
.badge-style{padding:4px 10px;border-radius:999px;font-size:11px;font-weight:600;background:rgba(107,63,160,.12);color:#c5b3f0;border:1px solid rgba(107,63,160,.2);}
.badge-new{padding:4px 10px;border-radius:999px;font-size:11px;font-weight:600;background:rgba(138,171,140,.1);color:var(--sage);border:1px solid rgba(138,171,140,.2);}
.del-btn{padding:5px 10px;border-radius:8px;border:1px solid rgba(232,85,62,.2);background:transparent;color:rgba(232,85,62,.6);font-size:11px;cursor:pointer;font-family:var(--font);transition:.15s;}
.del-btn:hover{background:rgba(232,85,62,.08);color:var(--coral);}
.empty-state{text-align:center;padding:60px 20px;color:rgba(245,242,238,.3);}
.empty-icon{font-size:36px;margin-bottom:12px;}

/* Export btn */
.btn-export{padding:9px 18px;border-radius:10px;background:rgba(138,171,140,.1);border:1px solid rgba(138,171,140,.25);color:var(--sage);font-family:var(--font);font-size:12px;font-weight:600;cursor:pointer;transition:.15s;}
.btn-export:hover{background:rgba(138,171,140,.18);}

.loading{text-align:center;padding:40px;color:rgba(245,242,238,.3);font-size:14px;}
</style>
</head>
<body>

<!-- â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="login-wrap" id="loginWrap">
  <div class="login-box">
    <div class="login-logo">ðŸŒ™ Lunara</div>
    <div class="login-sub">Admin Dashboard â€” restricted access</div>
    <div class="field">
      <label>Supabase URL</label>
      <input id="cfg_url" type="text" placeholder="https://xxxx.supabase.co" autocomplete="off"/>
    </div>
    <div class="field">
      <label>Service Role Key</label>
      <input id="cfg_key" type="password" placeholder="eyJhbGci..." autocomplete="off"/>
    </div>
    <div class="field">
      <label>Admin Password</label>
      <input id="cfg_pass" type="password" placeholder="Set your own password below"/>
    </div>
    <button class="btn-login" onclick="adminLogin()">Access Dashboard â†’</button>
    <div class="login-err" id="loginErr"></div>
    <div style="margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,.07);font-size:12px;color:rgba(245,242,238,.25);">
      Use your Supabase <strong>service_role</strong> key (not anon key) to bypass RLS and view all entries.
      Set ADMIN_PASSWORD to any string you want â€” just remember it.
    </div>
  </div>
</div>

<!-- â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="dash" id="dashWrap">
  <div class="topbar">
    <div class="topbar-brand">
      <div class="logo-pip">ðŸŒ™</div>
      Lunara Admin
    </div>
    <div class="topbar-right">
      <div class="live-dot"></div>
      <span style="font-size:12px;color:rgba(245,242,238,.4)">Live</span>
      <button class="btn-sm" onclick="loadData()">â†» Refresh</button>
      <button class="btn-sm danger" onclick="logout()">Log out</button>
    </div>
  </div>

  <div class="main">
    <!-- KPIs -->
    <div class="kpi-row">
      <div class="kpi-card accent">
        <div class="kpi-label">Total signups</div>
        <div class="kpi-val" id="kpi_total">â€”</div>
        <div class="kpi-sub">All time</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Last 24 hours</div>
        <div class="kpi-val" id="kpi_24h" style="color:var(--sage)">â€”</div>
        <div class="kpi-sub">New signups</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">This week</div>
        <div class="kpi-val" id="kpi_7d" style="color:var(--violet)">â€”</div>
        <div class="kpi-sub">Last 7 days</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Top style</div>
        <div class="kpi-val" id="kpi_top" style="font-size:18px;padding-top:4px">â€”</div>
        <div class="kpi-sub">Most common</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="chart-row">
      <div class="panel">
        <div class="panel-title">ðŸ“Š By relationship style</div>
        <div id="styleChart"><div class="loading">Loading...</div></div>
      </div>
      <div class="panel">
        <div class="panel-title">ðŸ“… Recent signups</div>
        <div id="recentList"><div class="loading">Loading...</div></div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-panel">
      <div class="table-top">
        <div class="table-title">All Waitlist Entries</div>
        <div style="display:flex;gap:10px;align-items:center;">
          <input class="search-input" id="searchInput" placeholder="Search name or email..." oninput="filterTable()"/>
          <button class="btn-export" onclick="exportCSV()">â¬‡ Export CSV</button>
        </div>
      </div>
      <div id="tableWrap"><div class="loading">Loading entries...</div></div>
    </div>
  </div>
</div>

<script>
// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ADMIN_PASSWORD = 'lunara2025'; // CHANGE THIS to your own password
let SUPA_URL = '';
let SUPA_KEY = '';
let allData  = [];

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function adminLogin(){
  const url  = document.getElementById('cfg_url').value.trim().replace(/\/$/, '');
  const key  = document.getElementById('cfg_key').value.trim();
  const pass = document.getElementById('cfg_pass').value;
  const err  = document.getElementById('loginErr');

  if(!url || !key){ err.textContent='Please enter your Supabase URL and key.'; err.style.display='block'; return; }
  if(pass !== ADMIN_PASSWORD){ err.textContent='Incorrect admin password.'; err.style.display='block'; return; }

  SUPA_URL = url;
  SUPA_KEY = key;
  sessionStorage.setItem('lunara_admin', JSON.stringify({url, key}));

  document.getElementById('loginWrap').style.display='none';
  document.getElementById('dashWrap').style.display='block';
  loadData();
}

function logout(){
  sessionStorage.removeItem('lunara_admin');
  location.reload();
}

// Auto-restore session
const saved = sessionStorage.getItem('lunara_admin');
if(saved){
  try {
    const {url, key} = JSON.parse(saved);
    SUPA_URL = url; SUPA_KEY = key;
    document.getElementById('loginWrap').style.display='none';
    document.getElementById('dashWrap').style.display='block';
  } catch(e){ sessionStorage.removeItem('lunara_admin'); }
}

// â”€â”€ Load data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData(){
  try {
    const res = await fetch(`${SUPA_URL}/rest/v1/waitlist?select=*&order=created_at.desc`, {
      headers:{
        'apikey': SUPA_KEY,
        'Authorization': `Bearer ${SUPA_KEY}`
      }
    });
    if(!res.ok) throw new Error(await res.text());
    allData = await res.json();
    renderDash();
  } catch(e){
    document.getElementById('tableWrap').innerHTML=`<div class="loading" style="color:#ff8080">Error loading data: ${e.message}</div>`;
  }
}

function renderDash(){
  const data = allData;
  const now  = new Date();

  // KPIs
  const last24 = data.filter(r => (now - new Date(r.created_at)) < 86400000).length;
  const last7d  = data.filter(r => (now - new Date(r.created_at)) < 604800000).length;

  document.getElementById('kpi_total').textContent = data.length;
  document.getElementById('kpi_24h').textContent   = last24;
  document.getElementById('kpi_7d').textContent    = last7d;

  // Style breakdown
  const styleCounts = {};
  data.forEach(r => { styleCounts[r.relationship_style] = (styleCounts[r.relationship_style]||0)+1; });
  const sortedStyles = Object.entries(styleCounts).sort((a,b)=>b[1]-a[1]);
  document.getElementById('kpi_top').textContent = sortedStyles[0]?.[0] || 'â€”';

  // Style chart
  const maxCount = sortedStyles[0]?.[1] || 1;
  document.getElementById('styleChart').innerHTML = sortedStyles.length ? sortedStyles.map(([style, count]) => `
    <div class="bar-item">
      <div class="bar-label"><span>${style}</span><span style="color:var(--coral);font-weight:700">${count}</span></div>
      <div class="bar-track"><div class="bar-fill" style="width:${(count/maxCount*100).toFixed(1)}%"></div></div>
    </div>`).join('') : '<div style="color:rgba(245,242,238,.3);font-size:13px">No data yet</div>';

  // Recent 5
  const recent = data.slice(0,5);
  document.getElementById('recentList').innerHTML = recent.length ? recent.map(r => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.05);">
      <div>
        <div style="font-size:13px;font-weight:600">${escHtml(r.display_name)}</div>
        <div style="font-size:11px;color:rgba(245,242,238,.35);margin-top:2px">${escHtml(r.email)}</div>
      </div>
      <div style="text-align:right">
        <span class="badge-style">${escHtml(r.relationship_style)}</span>
        <div style="font-size:11px;color:rgba(245,242,238,.3);margin-top:4px">${timeAgo(r.created_at)}</div>
      </div>
    </div>`).join('') : '<div style="color:rgba(245,242,238,.3);font-size:13px">No signups yet</div>';

  // Table
  renderTable(data);
}

function renderTable(data){
  if(!data.length){
    document.getElementById('tableWrap').innerHTML=`
      <div class="empty-state"><div class="empty-icon">ðŸŒ™</div><div>No waitlist entries yet.</div><div style="margin-top:6px;font-size:12px">Share your landing page to start collecting signups.</div></div>`;
    return;
  }
  document.getElementById('tableWrap').innerHTML=`
    <table>
      <thead><tr>
        <th>Name</th><th>Email</th><th>Style</th><th>Source</th><th>Signed up</th><th></th>
      </tr></thead>
      <tbody>${data.map(r=>`
        <tr>
          <td><strong>${escHtml(r.display_name)}</strong></td>
          <td style="color:rgba(245,242,238,.6)">${escHtml(r.email)}</td>
          <td><span class="badge-style">${escHtml(r.relationship_style)}</span></td>
          <td style="color:rgba(245,242,238,.4);font-size:12px">${escHtml(r.source||'landing_page')}</td>
          <td style="color:rgba(245,242,238,.4);font-size:12px">${formatDate(r.created_at)}</td>
          <td><button class="del-btn" onclick="deleteEntry('${r.id}','${escHtml(r.email)}')">Remove</button></td>
        </tr>`).join('')}
      </tbody>
    </table>`;
}

function filterTable(){
  const q = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allData.filter(r =>
    r.display_name.toLowerCase().includes(q) ||
    r.email.toLowerCase().includes(q) ||
    r.relationship_style.toLowerCase().includes(q)
  );
  renderTable(filtered);
}

async function deleteEntry(id, email){
  if(!confirm(`Remove ${email} from the waitlist?`)) return;
  await fetch(`${SUPA_URL}/rest/v1/waitlist?id=eq.${id}`,{
    method:'DELETE',
    headers:{'apikey':SUPA_KEY,'Authorization':`Bearer ${SUPA_KEY}`}
  });
  allData = allData.filter(r=>r.id!==id);
  renderDash();
}

function exportCSV(){
  if(!allData.length){ alert('No data to export.'); return; }
  const headers = ['ID','Name','Email','Relationship Style','Source','Referrer','Signed Up'];
  const rows = allData.map(r=>[
    r.id, r.display_name, r.email, r.relationship_style,
    r.source||'', r.referrer||'', r.created_at
  ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
  const csv = [headers.join(','), ...rows].join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `lunara_waitlist_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function formatDate(s){ return new Date(s).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
function timeAgo(s){
  const d = (Date.now()-new Date(s))/1000;
  if(d<60) return 'just now';
  if(d<3600) return Math.floor(d/60)+'m ago';
  if(d<86400) return Math.floor(d/3600)+'h ago';
  return Math.floor(d/86400)+'d ago';
}

// Auto-load if already logged in
if(SUPA_URL) loadData();
</script>
</body>
</html>
